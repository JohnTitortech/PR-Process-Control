<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Control Process PR</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>


  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #fafafa;
    }

    h1 {
      margin-bottom: 16px;
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 24px;
      margin-top: 20px;
    }

    .row {
      display: flex;
      gap: 24px;
      align-items: stretch;
    }

    .card {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      flex: 1;
    }

    .card h2 {
      font-size: 14px;
      text-align: center;
      margin-bottom: 10px;
    }

    canvas {
      max-height: 260px;
    }


    /* === PIE HTML LEGEND === */
    .pie-legend {
      display: grid;
      grid-auto-flow: column;     /* ini kuncinya */
      grid-template-rows: repeat(8, auto); /* 8 ke bawah */
      gap: 6px 16px;
      font-size: 12px;
      margin-top: 10px;
    }

    .pie-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pie-legend-color {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      flex-shrink: 0;
    }


  </style>
</head>
<body>

<h1 style="text-align: center;">Dashboard Control Process PR</h1>

<!-- ‚úÖ TOMBOL UPLOAD & REFRESH -->
<div style="text-align: center; margin: 20px 0; background: #f0f0f0; padding: 15px; border-radius: 8px;">
  <input type="file" id="fileInput" accept=".csv" style="display:none;">
  <button onclick="document.getElementById('fileInput').click()" 
          style="padding: 12px 24px; font-size: 16px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; margin-right: 10px;">
    üìÅ Upload CSV untuk Update Data
  </button>
  <button onclick="location.reload()" 
          style="padding: 12px 24px; font-size: 16px; cursor: pointer; background: #2196F3; color: white; border: none; border-radius: 5px;">
    üîÑ Refresh Dashboard
  </button>
  <div id="uploadStatus" style="margin-top: 10px; font-weight: bold;"></div>
</div>

<div id="periodInfo" style="margin-bottom:12px;font-weight:bold;"></div>

<div class="container" id="chartContainer"></div>

<script>
/* =========================
   CONFIG
========================= */


const SUPABASE_URL = "https://epawoaoslnwlyrcwkfvb.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_e8ZNaYuT78gqBIiunJZm7g_HWPMNFQG";

// ‚úÖ PERBAIKAN INISIALISASI SUPABASE
const { createClient } = supabase;
const supabaseClient = createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);


const PROJECT_MAP = {
  "230-24-VEHICLE CONVERSION-PROJECT-CONVERSION SALES REGULER-FORTUNER CCV": "Fortuner CCV (Reguler) - Item PR",
  "070-23-VEHICLE CONVERSION-PROJECT-CONV-AMBULANCE": "Fortuner Ambulance (Project) -  - Item PR",
  "143-25-VEHICLE CONVERSION-PROJECT-CONVERSION SALES REGULER-AMBULANCE FORTUNER": "Fortuner Ambulance (Reguler) - Item PR",
  "163-25-VEHICLE CONVERSION-PROJECT-CONVERSION SALES REGULER-SIENTA WELCAB": "Sienta Welcab (Reguler) - Item PR",
};

const ACTIVE_USER = "MILA";

const STATUS_PR = [
  "NEW PR",
  "APPROVE CL",
  "RECEIVE PURCHASING",
  "INPUT PRICE",
  "APPROVE MANAGER",
  // "APPROVE GM",
  // "APPROVE FGM",
  "APPROVE CL COST CONTROL",
  "APPROVE MANAGER COST CONTROL",
  "PRICE EVALUATION OK",
  "APPROVE CL PURCHASING",
  "APPROVE MANAGER PURCHASING",
  "APPROVE GM PURCHASING",
  // "APPROVE FGM PURCHASING",
  "PO PUBLISH",
  "PO RECEIVE SUPPLIER",
  "CREATE PACKING SLIP",
  "RECEIVED"
]

const EXCLUDED_STATUS = new Set([
  "NOT APPROVE CL",
  "NOT RECEIVE PURCHASING",
  "NOT APPROVE MANAJER",
  "NOT APPROVE GM",
  "NOT APPROVE FGM",
  "NOT APPROVE CL COST CONTROL",
  "NOT APPROVE MANAGER COST CONTROL",
  "PO CANCEL",
  "NOT APPROVE CL PURCHASING",
  "NOT APPROVE MANAGER PURCHASING",
  "NOT APPROVE GM PURCHASING",
  "NOT APPROVE FGM PURCHASING",
  "DELETE PR"
]);

const BAR_EXCLUDED_STATUS = new Set([
  "RECEIVED"
]);


const DETAIL_COLUMNS = [
  "NO",
  "PR NO",
  "PR DATE",
  "SECTION",
  "USER",
  "STATUS",
  "DATE REQUIRED",
  "ITEM NAME",
  "UM",
  "QTY",
  "CURR",
  "PRICE",
  "AMOUNT",
  "STATUS PR",
  "PROCESS DATE",
  "PROCESS USER",
  "BIIL APPROVAL",
  "DETAIL",
  "REMARK"
];

let rows = [];
let charts = [];


async function loadDataFromSupabase() {
  const { data, error } = await supabaseClient  // ‚úÖ GANTI dari supabase ke supabaseClient
    .from("PR LIST") // ‚¨ÖÔ∏è GANTI sesuai nama tabelmu
    .select("*");

  if (error) {
    console.error("Supabase error:", error);
    return;
  }

  rows = data
    .map(r => {
      const o = {};
      Object.keys(r).forEach(k => o[normalizeKey(k)] = r[k]);
      return o;
    })
    .filter(r =>
      r["USER"] === ACTIVE_USER &&
      !EXCLUDED_STATUS.has(r["STATUS PR"])
    );

  const periodText = getPRDatePeriod(rows);
  document.getElementById("periodInfo").textContent =
    periodText ? periodText : "";

  Chart.register(ChartDataLabels);
  renderCharts();
}


/* =========================
   UTIL
========================= */

function parsePRDate(value) {
  if (!value) return null;
  const d = new Date(value + "T00:00:00");
  return isNaN(d) ? null : d;
}

function formatDateID(date) {
  return date.toLocaleDateString("id-ID", {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
}

function getPRDatePeriod(rows) {
  const dates = rows
    .map(r => parsePRDate(r["PR DATE"]))
    .filter(d => d !== null);

  if (!dates.length) return null;

  const min = new Date(Math.min(...dates));
  const max = new Date(Math.max(...dates));

  return `Periode ${formatDateID(min)} - ${formatDateID(max)}`;
}

function getOrderedBarStatus(allStatusFromData) {
  return STATUS_PR
    //.filter(s => !BAR_EXCLUDED_STATUS.has(s))
    .filter(s => allStatusFromData.includes(s));
}

function normalizeKey(key) {
  return key.toString().toUpperCase().replace(/\s+/g, " ").trim();
}

function detectProject(bill) {
  if (!bill) return null;
  const text = bill.toString().toUpperCase().replace(/\s+/g, " ");
  return Object.keys(PROJECT_MAP).find(k => text.includes(k)) || null;
}

function getOrderedStatus(allStatusFromData) {
  const master = STATUS_PR.slice(); // urutan resmi
  const extras = allStatusFromData.filter(s => !master.includes(s));
  return [...master, ...extras];
}

function parseProcessDate(value) {
  if (!value) return null;
  const datePart = value.toString().split(" ")[0];
  const d = new Date(datePart + "T00:00:00");
  return isNaN(d) ? null : d;
}

function getDelayColor(delay) {
  if (delay === 1) return "#2ecc71";   // hijau
  if (delay === 2) return "#f1c40f";   // kuning
  if (delay === 3) return "#e67e22";   // orange
  return "#e74c3c";                    // merah (>=4)
}


function closeAllDetails() {
  Object.keys(PROJECT_MAP).forEach(k => {
    const el = document.getElementById(`detail-${k}`);
    if (el) el.style.display = "none";
  });
}



/* =========================
   PIE CHART (PER PR) ‚Äì TIDAK DIUBAH
========================= */
function buildPieData(projectKey) {
  const map = {}; // STATUS ‚Üí Set(PR)

  rows.forEach(r => {
    if (detectProject(r["BIIL APPROVAL"]) !== projectKey) return;
    if (!r["PR NO"] || !r["STATUS PR"]) return;

    const status = r["STATUS PR"];
    if (!map[status]) map[status] = new Set();
    map[status].add(r["PR NO"]);
  });

  const orderedStatus = getOrderedStatus(Object.keys(map));

  return {
    labels: orderedStatus,
    data: orderedStatus.map(s => map[s] ? map[s].size : 0),
    prMap: orderedStatus.map(s => map[s] ? Array.from(map[s]) : [])
  };
}

/* =========================
   BAR CHART (PER PR ‚Äì FIXED)
========================= */
function buildDelayData(projectKey) {
  const today = new Date();
  today.setHours(0,0,0,0);

  const statusMap = {};
  // STATUS ‚Üí delay ‚Üí [PR]

  rows.forEach(r => {
    if (detectProject(r["BIIL APPROVAL"]) !== projectKey) return;
    if (!r["PR NO"] || !r["STATUS PR"]) return;

    // ‚õî STOP RECEIVED DI BAR CHART
    if (r["STATUS PR"] === "RECEIVED") return;

    const d = parseProcessDate(r["PROCESS DATE"]);
    if (!d) return;

    let diff = Math.floor((today - d) / 86400000);
    if (diff <= 0) return;

    // üîí kunci maksimum days 14 hari
    if (diff > 14) diff = 14;

    const status = r["STATUS PR"];
    if (!statusMap[status]) statusMap[status] = {};
    if (!statusMap[status][diff]) statusMap[status][diff] = [];

    if (!statusMap[status][diff].includes(r["PR NO"])) {
      statusMap[status][diff].push(r["PR NO"]);
    }
  });

  const labels = getOrderedBarStatus(Object.keys(statusMap));

  const datasets = [];

  labels.forEach(status => {
    if (!statusMap[status]) return; // status master tapi kosong
    const delays = Object.keys(statusMap[status])
    .map(Number)
    .sort((a,b) => a-b);

    let prev = 0;

    delays.forEach(delay => {
      const delta = delay - prev;

      datasets.push({
        label: status,
        data: labels.map(l => l === status ? delta : 0),
        delayValue: delay,
        prList: statusMap[status][delay],
        backgroundColor: getDelayColor(delay)
      });

      prev = delay;
    });
  });

  return { labels, datasets };
}

function showDetailTable(projectKey, status, prList, delay = null) {
  closeAllDetails();
  const filtered = rows.filter(r => {
    if (detectProject(r["BIIL APPROVAL"]) !== projectKey) return false;
    if (r["STATUS PR"] !== status) return false;
    if (!prList.includes(r["PR NO"])) return false;

    if (delay !== null) {
      const d = parseProcessDate(r["PROCESS DATE"]);
      if (!d) return false;

      const today = new Date();
      today.setHours(0,0,0,0);

      const diff = Math.floor((today - d) / 86400000);
      if (diff !== delay) return false;
    }

    return true;
  });

  renderDetailTable(filtered, projectKey, status);
}

function renderDetailTable(data, projectKey, status) {
  const slot = document.getElementById(`detail-${projectKey}`);
  slot.innerHTML = "";
  slot.style.display = "block";


  let html = `
    <div class="card" id="detailTable">
      <h2>
        ${PROJECT_MAP[projectKey]}<br>
        Status: ${status}<br>
        Total Baris: ${data.length}
      </h2>

      <div style="overflow:auto; max-height:400px;">
        <table border="1" cellpadding="6" cellspacing="0"
          style="font-size:12px; white-space:nowrap;">
          <thead>
            <tr>
              ${DETAIL_COLUMNS.map(c => `<th>${c}</th>`).join("")}
            </tr>
          </thead>
          <tbody>
  `;

  data.forEach(r => {
    html += `
      <tr>
        ${DETAIL_COLUMNS.map(c => `<td>${r[c] ?? ""}</td>`).join("")}
      </tr>
    `;
  });

  html += `
          </tbody>
        </table>
      </div>
    </div>
  `;

  slot.appendChild(
  document.createRange().createContextualFragment(html)
);
}

/* =========================
   RENDER
========================= */
function clearCharts() {
  charts.forEach(c => c.destroy());
  charts = [];
  document.getElementById("chartContainer").innerHTML = "";
}

function renderCharts() {
  clearCharts();
  const container = document.getElementById("chartContainer");

  Object.keys(PROJECT_MAP).forEach(key => {
    const row = document.createElement("div");
    row.className = "row";

    const pieCard = document.createElement("div");
    pieCard.className = "card";

    const barCard = document.createElement("div");
    barCard.className = "card";

    const pieTitle = document.createElement("h2");
    pieTitle.textContent = PROJECT_MAP[key];

    const barTitle = document.createElement("h2");
    barTitle.textContent = "PR Delay Status (Days)";

    const pieCanvas = document.createElement("canvas");
    const barCanvas = document.createElement("canvas");

    pieCard.appendChild(pieTitle);
    pieCard.appendChild(pieCanvas);

    const legendDiv = document.createElement("div");
    legendDiv.className = "pie-legend";
    pieCard.appendChild(legendDiv);



    barCard.appendChild(barTitle);
    barCard.appendChild(barCanvas);

    row.appendChild(pieCard);
    row.appendChild(barCard);
    container.appendChild(row);

    // üîΩ TAMBAHKAN SLOT DETAIL KHUSUS PROJECT
    const detailSlot = document.createElement("div");
    detailSlot.id = `detail-${key}`;
    detailSlot.style.display = "none";
    container.appendChild(detailSlot);

    const pie = buildPieData(key);
    const bar = buildDelayData(key);

    if (pie.data.length) {

      const colors = pie.labels.map((_, i) =>
        `hsl(${(i * 360) / pie.labels.length}, 65%, 55%)`
      );

      const pieChart = new Chart(pieCanvas, {
        type: "pie",
        data: {
          labels: pie.labels,
          datasets: [{
            data: pie.data,
            prMap: pie.prMap,
            projectKey: key,
            backgroundColor: colors
          }]
        },
        options: {
          plugins: {
            legend: { display: false },

            datalabels: {
              color: "#fff",
              font: {
                weight: "bold",
                size: 12
              },
              formatter: (value, ctx) => {
                if (value === 0) return "";
                return value;
              }
            },

            tooltip: {
              callbacks: {
                label: ctx => {
                  const prs = ctx.dataset.prMap[ctx.dataIndex];
                  return [
                    `Total PR: ${prs.length}`,
                    `PR: ${prs.join(", ")}`
                  ];
                }
              }
            }
          },

          onClick: (evt, elements) => {
            if (!elements.length) return;
            const idx = elements[0].index;
            const status = pie.labels[idx];
            const prList = pie.prMap[idx];
            showDetailTable(key, status, prList);
          }
        }
      });

      charts.push(pieChart);


      pie.labels.forEach((label, i) => {
        const item = document.createElement("div");
        item.className = "pie-legend-item";

        const colorBox = document.createElement("div");
        colorBox.className = "pie-legend-color";
        colorBox.style.background = colors[i];

        const text = document.createElement("span");
        if (label === "RECEIVED") {
          text.textContent = `${label} (${pie.data[i]}) - CLOSED`;
        } else {
          text.textContent = `${label} (${pie.data[i]})`;
        }


        item.appendChild(colorBox);
        item.appendChild(text);
        legendDiv.appendChild(item);
      });


    }

    if (bar.datasets.length) {
      charts.push(new Chart(barCanvas, {
        type: "bar",
        data: {
          labels: bar.labels,
          datasets: bar.datasets
        },
        options: {
          indexAxis: "y",
          onClick: (evt, elements) => {
            if (!elements.length) return;
            const el = elements[0];
            const dataset = bar.datasets[el.datasetIndex];
            const status = bar.labels[el.index];
            showDetailTable(
              key,                // project
              status,             // status PR
              dataset.prList,     // PR list
              dataset.delayValue  // delay (opsional, buat info)
            );
          },
          scales: {
            x: {
              stacked: true,
              beginAtZero: true,
              min: 0,
              max: 14,
              ticks: {
                stepSize: 1
              },
              title: {
                display: true,
                text: "(Days)"
              }
            },
            y: {
              stacked: true
            }
          },
          plugins: {
            legend: { display: false },

            datalabels: {
              display:false
            },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const d = ctx.dataset;
                  return [
                    `Delay: ${d.delayValue} days`,
                    `Total PR: ${d.prList.length}`,
                    `PR: ${d.prList.join(", ")}`
                  ];
                }
              }
            }
          }
        }
      }));
    }
  });
}

// ========================================
// ‚úÖ UPLOAD CSV HANDLER - TARUH DI SINI
// ========================================
document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const status = document.getElementById('uploadStatus');
  status.textContent = '‚è≥ Membaca file CSV...';
  status.style.color = 'orange';

  try {
    // Parse CSV
    const data = await parseCSV(file);
    
    if (data.length === 0) {
      throw new Error('File CSV kosong atau format tidak valid');
    }

    status.textContent = `üìä ${data.length} baris terbaca. Menghapus SEMUA data lama...`;
    
    console.log('Sample data:', data[0]);
    console.log('Kolom CSV:', Object.keys(data[0]));
    
    // HAPUS SEMUA DATA
    try {
      let deleteSuccess = false;
      
      // METHOD 1: Coba pakai RPC truncate function (jika sudah dibuat)
      try {
        const { error: rpcError } = await supabaseClient
          .rpc('truncate_pr_list');
        
        if (!rpcError) {
          console.log('‚úÖ Truncate via RPC success');
          deleteSuccess = true;
        } else {
          console.log('RPC truncate not available:', rpcError.message);
        }
      } catch (rpcErr) {
        console.log('RPC method not available');
      }
      
      // METHOD 2: Delete dengan kondisi yang match semua
      if (!deleteSuccess) {
        const { error: deleteError1 } = await supabaseClient
          .from('PR LIST')
          .delete()
          .gte('PR NO', 0);
        
        if (!deleteError1) {
          console.log('‚úÖ Delete method 1 success (gte 0)');
          deleteSuccess = true;
        }
      }
      
      // METHOD 3: Delete dengan not null
      if (!deleteSuccess) {
        const { error: deleteError2 } = await supabaseClient
          .from('PR LIST')
          .delete()
          .not('PR NO', 'is', null);
        
        if (!deleteError2) {
          console.log('‚úÖ Delete method 2 success (not null)');
          deleteSuccess = true;
        }
      }
      
      // METHOD 4: Fetch semua dan delete batch
      if (!deleteSuccess) {
        console.log('Trying fetch and delete method...');
        const { data: allRows, error: fetchError } = await supabaseClient
          .from('PR LIST')
          .select('PR NO');
        
        if (!fetchError && allRows && allRows.length > 0) {
          const batchSize = 500;
          for (let i = 0; i < allRows.length; i += batchSize) {
            const batch = allRows.slice(i, i + batchSize);
            const prNums = batch.map(r => r['PR NO']);
            
            await supabaseClient
              .from('PR LIST')
              .delete()
              .in('PR NO', prNums);
            
            status.textContent = `üóëÔ∏è Menghapus: ${Math.min(i + batchSize, allRows.length)}/${allRows.length}...`;
          }
          console.log(`‚úÖ Deleted ${allRows.length} rows via fetch method`);
        }
      }
      
      status.textContent = `‚úÖ Data lama terhapus. Uploading ${data.length} baris baru...`;
      
    } catch (err) {
      throw new Error('Gagal menghapus data lama: ' + err.message);
    }

    // Insert data baru (batch 1000 rows at a time)
    const batchSize = 1000;
    for (let i = 0; i < data.length; i += batchSize) {
      const batch = data.slice(i, i + batchSize);
      const { error: insertError } = await supabaseClient
        .from('PR LIST')
        .insert(batch);

      if (insertError) throw insertError;
      
      status.textContent = `üì§ Upload: ${Math.min(i + batchSize, data.length)}/${data.length}...`;
    }

    status.textContent = `‚úÖ BERHASIL! ${data.length} data berhasil diupdate. Merefresh dashboard...`;
    status.style.color = 'green';

    // Auto reload setelah 2 detik
    setTimeout(() => {
      location.reload();
    }, 2000);

  } catch (err) {
    status.textContent = `‚ùå ERROR: ${err.message}`;
    status.style.color = 'red';
    console.error('Upload error:', err);
  }
  
  // Reset file input
  e.target.value = '';
});

// Fungsi Parse CSV (mendukung comma dan semicolon)
function parseCSV(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        let text = e.target.result;
        
        // ‚úÖ Hapus BOM (Byte Order Mark) jika ada
        if (text.charCodeAt(0) === 0xFEFF) {
          text = text.substring(1);
        }
        
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
          reject(new Error('CSV harus punya minimal header dan 1 baris data'));
          return;
        }

        // Deteksi delimiter (comma atau semicolon)
        const delimiter = lines[0].includes(';') ? ';' : ',';
        console.log(`Delimiter detected: "${delimiter}"`);

        // Parse header
        const headers = lines[0].split(delimiter).map(h => 
          h.trim().replace(/^"|"$/g, '') // hapus quotes
        );

        console.log('CSV Headers:', headers);

        // Parse data rows
        const data = [];
        for (let i = 1; i < lines.length; i++) {
          const values = parseCSVLine(lines[i], delimiter);
          
          if (values.length !== headers.length) {
            console.warn(`Baris ${i + 1} skip: ${values.length} kolom, expected ${headers.length}`);
            continue;
          }

          const obj = {};
          headers.forEach((header, idx) => {
            // Konversi string kosong jadi null
            obj[header] = values[idx] === '' ? null : values[idx];
          });
          
          data.push(obj);
        }

        resolve(data);
      } catch (err) {
        reject(err);
      }
    };
    
    reader.onerror = () => reject(new Error('Gagal membaca file'));
    reader.readAsText(file);
  });
}

// Parse CSV line dengan handling quotes dan custom delimiter
function parseCSVLine(line, delimiter = ',') {
  const result = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === delimiter && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  
  result.push(current.trim());
  return result.map(v => v.replace(/^"|"$/g, '')); // hapus quotes
}
// ========================================
// ‚úÖ END OF UPLOAD HANDLER
// ========================================

loadDataFromSupabase();

</script>

</body>
</html>
