<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Control Process PR</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #fafafa;
      margin: 0;
    }

    /* === LOGIN PAGE STYLES === */
    #loginPage {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px;
    }

    .login-container {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
    }

    .login-container h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 600;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    .login-btn:hover {
      background: #5568d3;
    }

    .error-message {
      color: #e74c3c;
      text-align: center;
      margin-top: 15px;
      display: none;
    }

    /* === DASHBOARD STYLES === */
    #dashboardPage {
      display: none;
    }

    .header-bar {
      background: white;
      padding: 15px 20px;
      margin: -20px -20px 20px -20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .user-badge {
      background: #667eea;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .logout-btn {
      padding: 8px 20px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }

    .logout-btn:hover {
      background: #c0392b;
    }

    h1 {
      margin-bottom: 16px;
      font-size: clamp(20px, 4vw, 28px);
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 24px;
      margin-top: 20px;
    }

    .row {
      display: flex;
      gap: 24px;
      align-items: stretch;
      flex-wrap: wrap;
    }

    .card {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      flex: 1;
      min-width: 280px;
    }

    .card h2 {
      font-size: clamp(12px, 2vw, 14px);
      text-align: center;
      margin-bottom: 10px;
    }

    canvas {
      max-height: 260px;
      width: 100% !important;
      height: auto !important;
    }

    /* === PIE HTML LEGEND === */
    .pie-legend {
      display: grid;
      grid-auto-flow: column;
      grid-template-rows: repeat(8, auto);
      gap: 6px 16px;
      font-size: 12px;
      margin-top: 10px;
    }

    .pie-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pie-legend-color {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .control-buttons {
      text-align: center;
      margin: 20px 0;
      background: #f0f0f0;
      padding: 15px;
      border-radius: 8px;
    }

    .btn {
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      margin: 5px;
      font-weight: 600;
      transition: opacity 0.3s;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn-upload {
      background: #4CAF50;
      color: white;
    }

    .btn-refresh {
      background: #2196F3;
      color: white;
    }

    /* Detail Table Responsive */
    #detailTable table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    #detailTable th,
    #detailTable td {
      padding: 8px;
      text-align: left;
      border: 1px solid #ddd;
    }

    #detailTable th {
      background-color: #667eea;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* === RESPONSIVE BREAKPOINTS === */

    /* Mobile Phones (Portrait) - 320px to 480px */
    @media screen and (max-width: 480px) {
      body {
        padding: 10px;
      }

      .login-container {
        padding: 25px 20px;
      }

      .login-container h1 {
        font-size: 20px;
      }

      .header-bar {
        margin: -10px -10px 15px -10px;
        padding: 12px 15px;
        flex-direction: column;
        text-align: center;
      }

      .user-info {
        justify-content: center;
        width: 100%;
      }

      .logout-btn {
        width: 100%;
      }

      h1 {
        font-size: 18px;
        text-align: center;
      }

      .row {
        flex-direction: column;
        gap: 15px;
      }

      .card {
        min-width: 100%;
        padding: 12px;
      }

      .pie-legend {
        grid-auto-flow: row;
        grid-template-rows: auto;
        grid-template-columns: 1fr;
        font-size: 11px;
      }

      .control-buttons {
        padding: 12px;
      }

      .btn {
        width: 100%;
        margin: 5px 0;
        padding: 10px 16px;
        font-size: 14px;
      }

      canvas {
        max-height: 200px;
      }

      #detailTable table {
        font-size: 10px;
      }

      #detailTable th,
      #detailTable td {
        padding: 4px;
      }
    }

    /* Mobile Phones (Landscape) & Small Tablets - 481px to 768px */
    @media screen and (min-width: 481px) and (max-width: 768px) {
      .header-bar {
        flex-direction: row;
      }

      .row {
        flex-direction: column;
        gap: 20px;
      }

      .card {
        min-width: 100%;
      }

      .pie-legend {
        grid-template-rows: repeat(4, auto);
        grid-auto-flow: column;
      }

      .btn {
        padding: 10px 20px;
        font-size: 15px;
      }

      canvas {
        max-height: 240px;
      }
    }

    /* Tablets (Portrait) - 769px to 1024px */
    @media screen and (min-width: 769px) and (max-width: 1024px) {
      .row {
        flex-direction: row;
        gap: 20px;
      }

      .card {
        min-width: calc(50% - 12px);
        flex: 1;
      }

      .pie-legend {
        grid-template-rows: repeat(6, auto);
        grid-auto-flow: column;
      }

      canvas {
        max-height: 250px;
      }
    }

    /* Laptops & Desktops - 1025px to 1440px */
    @media screen and (min-width: 1025px) and (max-width: 1440px) {
      .row {
        flex-direction: row;
        gap: 24px;
      }

      .card {
        min-width: calc(50% - 12px);
        flex: 1;
      }

      .pie-legend {
        grid-template-rows: repeat(8, auto);
        grid-auto-flow: column;
      }

      canvas {
        max-height: 260px;
      }
    }

    /* Large Screens & TVs - 1441px and above */
    @media screen and (min-width: 1441px) {
      body {
        padding: 30px;
        max-width: 1920px;
        margin: 0 auto;
      }

      .header-bar {
        padding: 20px 30px;
        margin: -30px -30px 30px -30px;
      }

      h1 {
        font-size: 32px;
      }

      .row {
        gap: 30px;
      }

      .card {
        padding: 24px;
        min-width: calc(50% - 15px);
      }

      .card h2 {
        font-size: 16px;
      }

      canvas {
        max-height: 320px;
      }

      .pie-legend {
        font-size: 14px;
        gap: 8px 20px;
      }

      .pie-legend-color {
        width: 12px;
        height: 12px;
      }

      .control-buttons {
        padding: 20px;
      }

      .btn {
        padding: 14px 28px;
        font-size: 18px;
      }

      #detailTable table {
        font-size: 14px;
      }

      #detailTable th,
      #detailTable td {
        padding: 10px;
      }
    }

    /* Ultra-wide screens - 2K and 4K */
    @media screen and (min-width: 2000px) {
      body {
        max-width: 2400px;
      }

      h1 {
        font-size: 36px;
      }

      .card h2 {
        font-size: 18px;
      }

      canvas {
        max-height: 400px;
      }

      .pie-legend {
        font-size: 16px;
      }
    }

    /* Print styles */
    @media print {
      body {
        background: white;
        padding: 0;
      }

      .header-bar,
      .control-buttons,
      .logout-btn {
        display: none !important;
      }

      .card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #333;
      }

      .row {
        break-inside: avoid;
      }
    }
  </style>
</head>
<body>

<!-- ========================================
     LOGIN PAGE
======================================== -->
<div id="loginPage">
  <div class="login-container">
    <h1>üîê Login Dashboard PR</h1>
    
    <form id="loginForm">
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="usernameInput" placeholder="Masukkan username" required />
      </div>

      <div class="form-group">
        <label>Password</label>
        <input type="password" id="passwordInput" placeholder="Masukkan password" required />
      </div>

      <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
        <input type="checkbox" id="rememberMe" style="width: auto; cursor: pointer;">
        <label for="rememberMe" style="margin: 0; cursor: pointer; font-weight: normal;">Remember Me</label>
      </div>

      <button type="submit" class="login-btn">LOGIN</button>
      
      <div class="error-message" id="errorMessage">Username atau password salah!</div>
    </form>

    /*<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px; color: #666;">
      <strong>Demo Credentials:</strong><br>
      MASTER: username = <code>admin</code>, password = <code>master123</code><br>
      USER: username = <code>user</code>, password = <code>user123</code>
    </div>*/
  </div>
</div>

<!-- ========================================
     DASHBOARD PAGE
======================================== -->
<div id="dashboardPage">
  <!-- Header Bar -->
  <div class="header-bar">
    <div class="user-info">
      <span class="user-badge" id="userBadge"></span>
      <span id="usernameDisplay"></span>
    </div>
    <button class="logout-btn" onclick="logout()">üö™ Logout</button>
  </div>

  <h1 style="text-align: center;">Dashboard Control Process PR</h1>

  <!-- Control Buttons (conditional) -->
  <div class="control-buttons" id="controlButtons">
    <input type="file" id="fileInput" accept=".csv" style="display:none;">
    <button id="uploadBtn" class="btn btn-upload" onclick="document.getElementById('fileInput').click()">
      üìÅ Upload CSV untuk Update Data
    </button>
    <button class="btn btn-refresh" onclick="location.reload()">
      üîÑ Refresh Dashboard
    </button>
    <div id="uploadStatus" style="margin-top: 10px; font-weight: bold;"></div>
  </div>

  <div id="periodInfo" style="margin-bottom:12px;font-weight:bold;text-align:center;"></div>
  <div id="lastUpdated" style="margin-bottom:12px;color:#666;font-size:14px;text-align:center;"></div>

  <div class="container" id="chartContainer"></div>
</div>

<script>
/* =========================
   LOGIN CREDENTIALS
========================= */
const CREDENTIALS = {
  MASTER: {
    username: 'admin',
    password: 'master123'
  },
  USER: {
    username: 'user',
    password: 'user123'
  }
};

let currentUser = null;

/* =========================
   LOGIN HANDLER
========================= */
document.getElementById('loginForm').addEventListener('submit', (e) => {
  e.preventDefault();
  
  const username = document.getElementById('usernameInput').value;
  const password = document.getElementById('passwordInput').value;
  const rememberMe = document.getElementById('rememberMe').checked;
  const errorMsg = document.getElementById('errorMessage');
  
  // Auto-detect role based on credentials
  let detectedRole = null;
  
  for (const [role, cred] of Object.entries(CREDENTIALS)) {
    if (cred.username === username && cred.password === password) {
      detectedRole = role;
      break;
    }
  }
  
  if (detectedRole) {
    // Login berhasil
    currentUser = {
      role: detectedRole,
      username: username
    };
    
    // Simpan session based on Remember Me
    if (rememberMe) {
      // Permanent storage (tetap walaupun browser ditutup)
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      localStorage.setItem('rememberMe', 'true');
    } else {
      // Temporary storage (hilang saat browser ditutup)
      sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
      // Hapus localStorage jika ada
      localStorage.removeItem('currentUser');
      localStorage.removeItem('rememberMe');
    }
    
    // Tampilkan dashboard
    showDashboard();
    
  } else {
    // Login gagal
    errorMsg.style.display = 'block';
    setTimeout(() => {
      errorMsg.style.display = 'none';
    }, 3000);
  }
});

/* =========================
   SHOW DASHBOARD
========================= */
function showDashboard() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('dashboardPage').style.display = 'block';
  
  // Update user info
  document.getElementById('userBadge').textContent = currentUser.role;
  document.getElementById('usernameDisplay').textContent = `Hello, ${currentUser.username}`;
  
  // Conditional UI based on role
  if (currentUser.role === 'USER') {
    // Hide upload button for USER
    document.getElementById('uploadBtn').style.display = 'none';
    document.getElementById('fileInput').style.display = 'none';
  }
  
  // Load dashboard data
  loadDataFromSupabase();
}

/* =========================
   LOGOUT
========================= */
function logout() {
  if (confirm('Yakin ingin logout?')) {
    // Hapus semua storage
    sessionStorage.removeItem('currentUser');
    localStorage.removeItem('currentUser');
    localStorage.removeItem('rememberMe');
    currentUser = null;
    location.reload();
  }
}

/* =========================
   CHECK SESSION ON LOAD
========================= */
window.addEventListener('DOMContentLoaded', () => {
  // Cek localStorage dulu (Remember Me)
  let savedUser = localStorage.getItem('currentUser');
  const rememberMe = localStorage.getItem('rememberMe') === 'true';
  
  // Jika tidak ada di localStorage, cek sessionStorage
  if (!savedUser) {
    savedUser = sessionStorage.getItem('currentUser');
  }
  
  if (savedUser) {
    currentUser = JSON.parse(savedUser);
    showDashboard();
    
    // Set checkbox Remember Me jika aktif
    if (rememberMe) {
      document.getElementById('rememberMe').checked = true;
    }
  }
});

/* =========================
   CONFIG SUPABASE
========================= */
const SUPABASE_URL = "https://epawoaoslnwlyrcwkfvb.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_e8ZNaYuT78gqBIiunJZm7g_HWPMNFQG";

const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const PROJECT_MAP = {
  "230-24-VEHICLE CONVERSION-PROJECT-CONVERSION SALES REGULER-FORTUNER CCV": "Fortuner CCV (Reguler) - Item PR",
  "070-23-VEHICLE CONVERSION-PROJECT-CONV-AMBULANCE": "Fortuner Ambulance (Project) - Item PR",
  "143-25-VEHICLE CONVERSION-PROJECT-CONVERSION SALES REGULER-AMBULANCE FORTUNER": "Fortuner Ambulance (Reguler) - Item PR",
  "163-25-VEHICLE CONVERSION-PROJECT-CONVERSION SALES REGULER-SIENTA WELCAB": "Sienta Welcab (Reguler) - Item PR",
  "004-25-VEHICLE, QUALITY & AFTER SALES-EXPENSES-REPAIR & MAINTENANCE-ASSET - PREVENTIVE MAINTENANCE": "Preventive Maintenance - Item PR",
  "012-25-VEHICLE CONVERSION-EXPENSES-REPAIR & MAINTENANCE-GENERAL - ROUTINE INSPECTION/SERVICE": "Routine Inspection/Service - Item PR",
  "014-25-VEHICLE CONVERSION-EXPENSES-REPAIR & MAINTENANCE-GENERAL - SPAREPART": "Sparepart - Item PR",
  "015-25-VEHICLE CONVERSION-EXPENSES-REPAIR & MAINTENANCE-GENERAL - TOOLS & EQUIPMENT": "Tools & Equipment - Item PR",
  "083-25-VEHICLE CONVERSION-EXPENSES-ADMINISTRATION EXPENSES-GENERAL & ADMINISTRATION": "General & Administration - Item PR"
};

const ACTIVE_USER = "MILA";

const STATUS_PR = [
  "NEW PR",
  "APPROVE CL",
  "RECEIVE PURCHASING",
  "INPUT PRICE",
  "APPROVE MANAGER",
  "APPROVE CL COST CONTROL",
  "APPROVE MANAGER COST CONTROL",
  "PRICE EVALUATION OK",
  "APPROVE CL PURCHASING",
  "APPROVE MANAGER PURCHASING",
  "APPROVE GM PURCHASING",
  "PO PUBLISH",
  "PO RECEIVE SUPPLIER",
  "CREATE PACKING SLIP",
  "RECEIVED"
];

const EXCLUDED_STATUS = new Set([
  "NOT APPROVE CL",
  "NOT RECEIVE PURCHASING",
  "NOT APPROVE MANAJER",
  "NOT APPROVE GM",
  "NOT APPROVE FGM",
  "NOT APPROVE CL COST CONTROL",
  "NOT APPROVE MANAGER COST CONTROL",
  "PO CANCEL",
  "NOT APPROVE CL PURCHASING",
  "NOT APPROVE MANAGER PURCHASING",
  "NOT APPROVE GM PURCHASING",
  "NOT APPROVE FGM PURCHASING",
  "DELETE PR"
]);

const BAR_EXCLUDED_STATUS = new Set(["RECEIVED"]);

const DETAIL_COLUMNS = [
  "PR NO", 
  "PR DATE", 
  "USER", 
  "ITEM NAME", 
  "UM", 
  "QTY", 
  "STATUS PR",
  "PROCESS DATE", 
  "PROCESS USER", 
  "BIIL APPROVAL", 
  "DETAIL", 
  "REMARK"
];

let rows = [];
let charts = [];

/* =========================
   LOAD DATA FROM SUPABASE
========================= */
async function loadDataFromSupabase() {
  const { data, error } = await supabaseClient
    .from("PR LIST")
    .select("*");

  if (error) {
    console.error("Supabase error:", error);
    return;
  }

  rows = data
    .map(r => {
      const o = {};
      Object.keys(r).forEach(k => o[normalizeKey(k)] = r[k]);
      return o;
    })
    .filter(r =>
      r["USER"] === ACTIVE_USER &&
      !EXCLUDED_STATUS.has(r["STATUS PR"])
    );

  const periodText = getPRDatePeriod(rows);
  document.getElementById("periodInfo").textContent = periodText ? periodText : "";
  
  // Display last updated timestamp from Supabase
  await displayLastUpdatedFromSupabase();

  Chart.register(ChartDataLabels);
  renderCharts();
}

/* =========================
   UTILITY FUNCTIONS
========================= */
function formatLastUpdated(timestamp) {
  if (!timestamp) return '';
  
  const date = new Date(timestamp);
  const options = {
    hour: '2-digit',
    minute: '2-digit',
    day: 'numeric',
    month: 'long',
    year: 'numeric',
    timeZone: 'Asia/Jakarta'
  };
  
  const formatter = new Intl.DateTimeFormat('en-GB', options);
  const parts = formatter.formatToParts(date);
  
  const time = parts.filter(p => p.type === 'hour' || p.type === 'minute' || p.type === 'literal' && p.value === ':')
    .map(p => p.value).join('');
  const day = parts.find(p => p.type === 'day').value;
  const month = parts.find(p => p.type === 'month').value;
  const year = parts.find(p => p.type === 'year').value;
  
  return `Last updated: ${time} ¬∑ ${day} ${month} ${year}`;
}

function displayLastUpdated() {
  const lastUpdated = localStorage.getItem('lastUpdated');
  const element = document.getElementById('lastUpdated');
  
  if (lastUpdated && element) {
    element.textContent = formatLastUpdated(lastUpdated);
  }
}

async function displayLastUpdatedFromSupabase() {
  const element = document.getElementById('lastUpdated');
  if (!element) return;
  
  try {
    const { data, error } = await supabaseClient
      .from('SYSTEM_INFO')
      .select('value')
      .eq('key', 'last_updated')
      .single();
    
    if (error) {
      console.log('No last_updated info in Supabase:', error.message);
      // Fallback to localStorage
      displayLastUpdated();
      return;
    }
    
    if (data && data.value) {
      element.textContent = formatLastUpdated(data.value);
    }
  } catch (err) {
    console.log('Error fetching last_updated:', err);
    // Fallback to localStorage
    displayLastUpdated();
  }
}

function parsePRDate(value) {
  if (!value) return null;
  const d = new Date(value + "T00:00:00");
  return isNaN(d) ? null : d;
}

function formatDateID(date) {
  return date.toLocaleDateString("id-ID", {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
}

function getPRDatePeriod(rows) {
  const dates = rows
    .map(r => parsePRDate(r["PR DATE"]))
    .filter(d => d !== null);

  if (!dates.length) return null;

  const min = new Date(Math.min(...dates));
  const max = new Date(Math.max(...dates));

  return `Periode ${formatDateID(min)} - ${formatDateID(max)}`;
}

function getOrderedBarStatus(allStatusFromData) {
  return STATUS_PR.filter(s => allStatusFromData.includes(s));
}

function normalizeKey(key) {
  return key.toString().toUpperCase().replace(/\s+/g, " ").trim();
}

function detectProject(bill) {
  if (!bill) return null;
  const text = bill.toString().toUpperCase().replace(/\s+/g, " ");
  return Object.keys(PROJECT_MAP).find(k => text.includes(k)) || null;
}

function getOrderedStatus(allStatusFromData) {
  const master = STATUS_PR.slice();
  const extras = allStatusFromData.filter(s => !master.includes(s));
  return [...master, ...extras];
}

function parseProcessDate(value) {
  if (!value) return null;
  const datePart = value.toString().split(" ")[0];
  const d = new Date(datePart + "T00:00:00");
  return isNaN(d) ? null : d;
}

function getDelayColor(delay) {
  if (delay === 1) return "#2ecc71";
  if (delay === 2) return "#f1c40f";
  if (delay === 3) return "#e67e22";
  return "#e74c3c";
}

function closeAllDetails() {
  Object.keys(PROJECT_MAP).forEach(k => {
    const el = document.getElementById(`detail-${k}`);
    if (el) el.style.display = "none";
  });
}

/* =========================
   PIE CHART
========================= */
function buildPieData(projectKey) {
  const map = {};

  rows.forEach(r => {
    if (detectProject(r["BIIL APPROVAL"]) !== projectKey) return;
    if (!r["PR NO"] || !r["STATUS PR"]) return;

    const status = r["STATUS PR"];
    if (!map[status]) map[status] = new Set();
    map[status].add(r["PR NO"]);
  });

  const orderedStatus = getOrderedStatus(Object.keys(map));

  return {
    labels: orderedStatus,
    data: orderedStatus.map(s => map[s] ? map[s].size : 0),
    prMap: orderedStatus.map(s => map[s] ? Array.from(map[s]) : [])
  };
}

/* =========================
   BAR CHART
========================= */
function buildDelayData(projectKey) {
  const today = new Date();
  today.setHours(0,0,0,0);

  const statusMap = {};

  rows.forEach(r => {
    if (detectProject(r["BIIL APPROVAL"]) !== projectKey) return;
    if (!r["PR NO"] || !r["STATUS PR"]) return;

    if (r["STATUS PR"] === "RECEIVED") return;

    const d = parseProcessDate(r["PROCESS DATE"]);
    if (!d) return;

    let diff = Math.floor((today - d) / 86400000);
    if (diff <= 0) return;

    if (diff > 14) diff = 14;

    const status = r["STATUS PR"];
    if (!statusMap[status]) statusMap[status] = {};
    if (!statusMap[status][diff]) statusMap[status][diff] = [];

    if (!statusMap[status][diff].includes(r["PR NO"])) {
      statusMap[status][diff].push(r["PR NO"]);
    }
  });

  const labels = getOrderedBarStatus(Object.keys(statusMap));
  const datasets = [];

  labels.forEach(status => {
    if (!statusMap[status]) return;
    const delays = Object.keys(statusMap[status])
      .map(Number)
      .sort((a,b) => a-b);

    let prev = 0;

    delays.forEach(delay => {
      const delta = delay - prev;

      datasets.push({
        label: status,
        data: labels.map(l => l === status ? delta : 0),
        delayValue: delay,
        prList: statusMap[status][delay],
        backgroundColor: getDelayColor(delay)
      });

      prev = delay;
    });
  });

  return { labels, datasets };
}

function showDetailTable(projectKey, status, prList, delay = null) {
  closeAllDetails();
  
  console.log('showDetailTable called with:', {
    projectKey,
    status,
    prList,
    delay
  });
  
  const filtered = rows.filter(r => {
    // Filter by project
    if (detectProject(r["BIIL APPROVAL"]) !== projectKey) return false;
    
    // Filter by status
    if (r["STATUS PR"] !== status) return false;
    
    // Filter by PR list
    if (!prList.includes(r["PR NO"])) return false;

    // Jika dari bar chart (delay ada), filter juga by delay
    if (delay !== null) {
      const d = parseProcessDate(r["PROCESS DATE"]);
      if (!d) return false;

      const today = new Date();
      today.setHours(0,0,0,0);

      const diff = Math.floor((today - d) / 86400000);
      
      // Kunci maksimum delay 14 hari (sama seperti di buildDelayData)
      let actualDiff = diff;
      if (actualDiff > 14) actualDiff = 14;
      
      if (actualDiff !== delay) return false;
    }

    return true;
  });
  
  console.log('Filtered results:', filtered.length, 'rows');

  renderDetailTable(filtered, projectKey, status);
}

function renderDetailTable(data, projectKey, status) {
  const slot = document.getElementById(`detail-${projectKey}`);
  slot.innerHTML = "";
  slot.style.display = "block";

  let html = `
    <div class="card" id="detailTable">
      <h2>
        ${PROJECT_MAP[projectKey]}<br>
        Status: ${status}<br>
        Total Baris: ${data.length}
      </h2>

      <div style="overflow:auto; max-height:400px;">
        <table border="1" cellpadding="6" cellspacing="0"
          style="font-size:12px; white-space:nowrap;">
          <thead>
            <tr>
              ${DETAIL_COLUMNS.map(c => `<th>${c}</th>`).join("")}
            </tr>
          </thead>
          <tbody>
  `;

  data.forEach(r => {
    html += `
      <tr>
        ${DETAIL_COLUMNS.map(c => `<td>${r[c] ?? ""}</td>`).join("")}
      </tr>
    `;
  });

  html += `
          </tbody>
        </table>
      </div>
    </div>
  `;

  slot.appendChild(
    document.createRange().createContextualFragment(html)
  );
}

/* =========================
   RENDER CHARTS
========================= */
function clearCharts() {
  charts.forEach(c => c.destroy());
  charts = [];
  document.getElementById("chartContainer").innerHTML = "";
}

function renderCharts() {
  clearCharts();
  const container = document.getElementById("chartContainer");

  Object.keys(PROJECT_MAP).forEach(key => {
    const row = document.createElement("div");
    row.className = "row";

    const pieCard = document.createElement("div");
    pieCard.className = "card";

    const barCard = document.createElement("div");
    barCard.className = "card";

    const pieTitle = document.createElement("h2");
    pieTitle.textContent = PROJECT_MAP[key];

    const barTitle = document.createElement("h2");
    barTitle.textContent = "PR Delay Status (Days)";

    const pieCanvas = document.createElement("canvas");
    const barCanvas = document.createElement("canvas");

    pieCard.appendChild(pieTitle);
    pieCard.appendChild(pieCanvas);

    const legendDiv = document.createElement("div");
    legendDiv.className = "pie-legend";
    pieCard.appendChild(legendDiv);

    barCard.appendChild(barTitle);
    barCard.appendChild(barCanvas);

    row.appendChild(pieCard);
    row.appendChild(barCard);
    container.appendChild(row);

    const detailSlot = document.createElement("div");
    detailSlot.id = `detail-${key}`;
    detailSlot.style.display = "none";
    container.appendChild(detailSlot);

    const pie = buildPieData(key);
    const bar = buildDelayData(key);

    if (pie.data.length) {
      const colors = pie.labels.map((_, i) =>
        `hsl(${(i * 360) / pie.labels.length}, 65%, 55%)`
      );

      const pieChart = new Chart(pieCanvas, {
        type: "pie",
        data: {
          labels: pie.labels,
          datasets: [{
            data: pie.data,
            prMap: pie.prMap,
            projectKey: key,
            backgroundColor: colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            datalabels: {
              color: "#fff",
              font: { weight: "bold", size: 12 },
              formatter: (value, ctx) => value === 0 ? "" : value
            },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const prs = ctx.dataset.prMap[ctx.dataIndex];
                  return [
                    `Total PR: ${prs.length}`,
                    `PR: ${prs.join(", ")}`
                  ];
                }
              }
            }
          },
          onClick: (evt, elements) => {
            if (!elements.length) return;
            const idx = elements[0].index;
            const status = pie.labels[idx];
            const prList = pie.prMap[idx];
            showDetailTable(key, status, prList);
          }
        }
      });

      charts.push(pieChart);

      pie.labels.forEach((label, i) => {
        const item = document.createElement("div");
        item.className = "pie-legend-item";

        const colorBox = document.createElement("div");
        colorBox.className = "pie-legend-color";
        colorBox.style.background = colors[i];

        const text = document.createElement("span");
        if (label === "RECEIVED") {
          text.textContent = `${label} (${pie.data[i]}) - CLOSED`;
        } else {
          text.textContent = `${label} (${pie.data[i]})`;
        }

        item.appendChild(colorBox);
        item.appendChild(text);
        legendDiv.appendChild(item);
      });
    }

    if (bar.datasets.length) {
      charts.push(new Chart(barCanvas, {
        type: "bar",
        data: {
          labels: bar.labels,
          datasets: bar.datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          indexAxis: "y",
          onClick: (evt, elements) => {
            if (!elements.length) return;
            
            const el = elements[0];
            const dataset = bar.datasets[el.datasetIndex];
            const status = bar.labels[el.index];
            
            console.log('Bar clicked:', {
              status,
              delayValue: dataset.delayValue,
              prList: dataset.prList,
              prListLength: dataset.prList ? dataset.prList.length : 0
            });
            
            showDetailTable(key, status, dataset.prList, dataset.delayValue);
          },
          scales: {
            x: {
              stacked: true,
              beginAtZero: true,
              min: 0,
              max: 14,
              ticks: { stepSize: 1 },
              title: { display: true, text: "(Days)" }
            },
            y: { stacked: true }
          },
          plugins: {
            legend: { display: false },
            datalabels: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const d = ctx.dataset;
                  return [
                    `Delay: ${d.delayValue} days`,
                    `Total PR: ${d.prList.length}`,
                    `PR: ${d.prList.join(", ")}`
                  ];
                }
              }
            }
          }
        }
      }));
    }
  });
}

/* =========================
   CSV UPLOAD HANDLER
========================= */
document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const status = document.getElementById('uploadStatus');
  status.textContent = '‚è≥ Membaca file CSV...';
  status.style.color = 'orange';

  try {
    const data = await parseCSV(file);
    
    if (data.length === 0) {
      throw new Error('File CSV kosong atau format tidak valid');
    }

    status.textContent = `üìä ${data.length} baris terbaca. Menghapus SEMUA data lama...`;
    
    console.log('Sample data:', data[0]);
    console.log('Kolom CSV:', Object.keys(data[0]));
    
    try {
      let deleteSuccess = false;
      
      try {
        const { error: rpcError } = await supabaseClient.rpc('truncate_pr_list');
        
        if (!rpcError) {
          console.log('‚úÖ Truncate via RPC success');
          deleteSuccess = true;
        } else {
          console.log('RPC truncate not available:', rpcError.message);
        }
      } catch (rpcErr) {
        console.log('RPC method not available');
      }
      
      if (!deleteSuccess) {
        const { error: deleteError1 } = await supabaseClient
          .from('PR LIST')
          .delete()
          .gte('PR NO', 0);
        
        if (!deleteError1) {
          console.log('‚úÖ Delete method 1 success (gte 0)');
          deleteSuccess = true;
        }
      }
      
      if (!deleteSuccess) {
        const { error: deleteError2 } = await supabaseClient
          .from('PR LIST')
          .delete()
          .not('PR NO', 'is', null);
        
        if (!deleteError2) {
          console.log('‚úÖ Delete method 2 success (not null)');
          deleteSuccess = true;
        }
      }
      
      if (!deleteSuccess) {
        console.log('Trying fetch and delete method...');
        const { data: allRows, error: fetchError } = await supabaseClient
          .from('PR LIST')
          .select('PR NO');
        
        if (!fetchError && allRows && allRows.length > 0) {
          const batchSize = 500;
          for (let i = 0; i < allRows.length; i += batchSize) {
            const batch = allRows.slice(i, i + batchSize);
            const prNums = batch.map(r => r['PR NO']);
            
            await supabaseClient
              .from('PR LIST')
              .delete()
              .in('PR NO', prNums);
            
            status.textContent = `üóëÔ∏è Menghapus: ${Math.min(i + batchSize, allRows.length)}/${allRows.length}...`;
          }
          console.log(`‚úÖ Deleted ${allRows.length} rows via fetch method`);
        }
      }
      
      status.textContent = `‚úÖ Data lama terhapus. Uploading ${data.length} baris baru...`;
      
    } catch (err) {
      throw new Error('Gagal menghapus data lama: ' + err.message);
    }

    const batchSize = 1000;
    for (let i = 0; i < data.length; i += batchSize) {
      const batch = data.slice(i, i + batchSize);
      const { error: insertError } = await supabaseClient
        .from('PR LIST')
        .insert(batch);

      if (insertError) throw insertError;
      
      status.textContent = `üì§ Upload: ${Math.min(i + batchSize, data.length)}/${data.length}...`;
    }

    status.textContent = `‚úÖ BERHASIL! ${data.length} data berhasil diupdate. Merefresh dashboard...`;
    status.style.color = 'green';
    
    // Save timestamp to Supabase
    const timestamp = new Date().toISOString();
    localStorage.setItem('lastUpdated', timestamp);
    
    try {
      await supabaseClient
        .from('SYSTEM_INFO')
        .upsert({ 
          key: 'last_updated', 
          value: timestamp 
        }, { 
          onConflict: 'key' 
        });
      console.log('‚úÖ Timestamp saved to Supabase');
    } catch (err) {
      console.log('Failed to save timestamp to Supabase:', err);
    }

    setTimeout(() => {
      location.reload();
    }, 2000);

  } catch (err) {
    status.textContent = `‚ùå ERROR: ${err.message}`;
    status.style.color = 'red';
    console.error('Upload error:', err);
  }
  
  e.target.value = '';
});

function parseCSV(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        let text = e.target.result;
        
        if (text.charCodeAt(0) === 0xFEFF) {
          text = text.substring(1);
        }
        
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
          reject(new Error('CSV harus punya minimal header dan 1 baris data'));
          return;
        }

        const delimiter = lines[0].includes(';') ? ';' : ',';
        console.log(`Delimiter detected: "${delimiter}"`);

        const headers = lines[0].split(delimiter).map(h => 
          h.trim().replace(/^"|"$/g, '')
        );

        console.log('CSV Headers:', headers);

        const data = [];
        for (let i = 1; i < lines.length; i++) {
          const values = parseCSVLine(lines[i], delimiter);
          
          if (values.length !== headers.length) {
            console.warn(`Baris ${i + 1} skip: ${values.length} kolom, expected ${headers.length}`);
            continue;
          }

          const obj = {};
          headers.forEach((header, idx) => {
            obj[header] = values[idx] === '' ? null : values[idx];
          });
          
          data.push(obj);
        }

        resolve(data);
      } catch (err) {
        reject(err);
      }
    };
    
    reader.onerror = () => reject(new Error('Gagal membaca file'));
    reader.readAsText(file);
  });
}

function parseCSVLine(line, delimiter = ',') {
  const result = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === delimiter && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  
  result.push(current.trim());
  return result.map(v => v.replace(/^"|"$/g, ''));
}
</script>

</body>
</html>

